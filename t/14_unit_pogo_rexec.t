#!/usr/bin/env perl -w
# Copyright (c) 2010-2011 Yahoo! Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

use 5.008;
use common::sense;
use strict;
use warnings;

use Test::Exception;
use Test::More tests => 7;

use Carp qw(confess);
use Data::Dumper;
use FindBin qw($Bin);
use Log::Log4perl qw(:easy);

use lib "$Bin/../lib";
use lib "$Bin/lib";

use PogoTesterAlarm;

use IPC::Open3 qw(open3);
use IO::File;

# Disable any existing SIGCHLD handlers that may be interfering
# with our ability to catch our subprocesses exit status.

# Launch our helper program

my $exec_helper    = "$Bin/../bin/pogo-rexec";
my $expect_wrapper = "$Bin/../bin/pogo-pw";
my $worker_key     = "$Bin/conf/worker.key";

my $output;

#test with password only, incorrect password
lives_ok
{
  my ( $writer, $reader ) = ( IO::Handle->new, IO::Handle->new );
  my $pid =
    open3( $writer, $reader, undef, $exec_helper, '-e', $expect_wrapper, '-k', $worker_key );

  my $task =
    '{"client_private_key":null,"job_id":"p0000000013","secrets":"CqQbV/yhFMAFoFd+E3nrAgYPVOB3OY+YzZkSKxlS/07gbH0zkbC2+hWHn6+G8zsIz86Tldvl+Wqt\nYLvAL5nlGfY4ydn0MmQGma7ScC2bAKpIoYr40M36uGV78cW+cAFb/Bz60Jxu1yufNaCOvdMR1aCz\n6JdWqwVm2/GQcbV5AC2YVrZAiw8kjPJW9guPCB9INSF8fTFHZYPl70gEE1uZ2M26gRu5+PJVnp5H\nVnMWgWHbydqoNs9dLDPwF93HekmewDJJ6FxMSJeMTrDEmyG1H+vUVd6//YR4QSN9OeXxFUzm4kDH\nZM+mj2CgJkAtaAte2t0BDrDG7+mqCIHOoZpOhl7VNeJES2sM4oFv6pjJbXTo3ICeZn3WY4V+gtOW\nPwvksjK4PcHCz14e/IR2yDh9cBpt2DWfwVXes5MJQfx1Jz6GJm5pBdi5zxy8mVmrolcPWC+ZCrSf\nGV6r+x89wKWL4HreMb/BUw1lGEk9J74a9fiyAaaj1b/+C1Yc4DoQL377koRBTlon7SeLjMw5l9vU\nl4iOs2QdmQosgLqHmcpdZPekraGmifYQusDQ+mPxfku/ZZasyJFoKX13/iRRW3DVrk3L6UFx+dGC\n6CFmyQefjsuDp2R0bAiF8ogXm/qwP+V11J3Yeaar6jHqJpA7OKJsL9jQrRf7jStMs4ucXI6eseI=\n","run_as":"ssingan","host":"localhost","password":"ZMztBUxwlsPZSaKPprizMkkEPKpA/m6kh6UvDCT02fLe/uAE7HKxFl6q+9jYRJ6ttHB43eFZr12H\nnP/zK5x+8WbIGdKb34gC10UgPqoaTu91Z4O4zVfKKtu4cUVJHG/JWcwk7Id3lybhpb88uVKIuakB\ny5Mo1pkiwOzmYg2uqdbdJ14YwihuKpgiiJGzP32Prdu+PYEOxY8OmeJbCUcJBRMmWDYaGygmLPrk\ndfc7g/YR0KxtRFKBeSBvOi2vKQWA0XcJlbeldRD3qjVQeNQk58bl3cAzJHmhQIh03Iw+LkVEfsIj\nfM3Nc37/3jp0ynPGJLl5kw8BlzVt687gHBzny/RUwJ4U7PXZN6Dqk8uamx6C3lB3ixI9tdCySpcx\nvVau1fT9KOkxRpaDBG1Mi3GoR3KbGCYFLqeptcJtCzdoK7DejzQ4wP273ePAe1OHvzaRrBSzOWI2\nTRi54Glj9Aii4uDKrfwJvb2vcEyQVPp0yBUxnRJ+Hn1yEGWuDHS2KPU7xe+hRJTbChE1I/mww/lV\nIwiuggxJIqycakcu3UYgqXlu5BZ/zpXeFqUd75vYEmZ/8zMaCfe2hswynJKZBlCQpdhWp3uZAyls\nq5MCknM8cTpZDidt1r2DXS5X+kvmtJ9pbC00coWfr2IRWLbKzIVarriKW5WtCn0c9FwLp+/TG3g=\n","timeout":"5","pvt_key_passphrase":null,"user":"ssingan","command":["POGOATTACHMENT!IyEvdXNyL2Jpbi9lbnYgcGVybAoKdXNlIDUuMDA4Owp1c2Ugd2FybmluZ3M7CnVzZSBzdHJpY3Q7\nCgp1c2UgRmNudGw7CnVzZSBGaWxlOjpUZW1wIHF3KHRlbXBmaWxlKTsKdXNlIFN5czo6SG9zdG5h\nbWUgcXcoaG9zdG5hbWUpOwp1c2UgY29uc3RhbnQgTE9DS0ZJTEUgICAgID0+ICcvdG1wL3BvZ29f\nd29ya2VyLmxvY2snOwp1c2UgY29uc3RhbnQgUE9TVF9IT09LRElSID0+ICcvZXRjL3BvZ28vcG9z\ndC5kLyc7CnVzZSBjb25zdGFudCBQUkVfSE9PS0RJUiAgPT4gJy9ldGMvcG9nby9wcmUuZC8nOwp1\nc2UgY29uc3RhbnQgVEVNUERJUiAgICAgID0+ICcvdG1wJzsKdXNlIFNhZmU7CgokU0lHe0hVUH0g\nPSAkU0lHe0lOVH0gPSAkU0lHe1RFUk19ID0gJFNJR3tfX0RJRV9ffSA9IFwmY2xlYW51cDsKCm15\nICRob3N0bmFtZSA9IGhvc3RuYW1lKCk7Cm15ICRsb2NrZWQgICA9IDA7Cm15ICRsb2NrZmggICA9\nIHVuZGVmOwpteSAkb3B0cyAgICAgPSB1bmRlZjsKbXkgJHRlbXBmaWxlID0gdW5kZWY7CgpzdWIg\nY2xlYW51cCB7CiAgbXkgJG1zZyA9IHNoaWZ0OwogIGlmICggJG1zZyA9fiBtL15bQS1aXSskLyAp\nIHsgJG1zZyA9ICdnb3QgU0lHJyAuICRtc2c7IH0KICBpZiAoICR0ZW1wZmlsZSAmJiAtZSAkdGVt\ncGZpbGUgKSB7CiAgICB1bmxpbmsgJHRlbXBmaWxlOwogIH0KICBpZiAoJGxvY2tlZCkgewogICAg\ncHJpbnQgInBvZ28td29ya2VyOiB1bmxvY2tpbmdcbiI7CiAgICBjbG9zZSAkbG9ja2ZoOwogICAg\ndW5saW5rIExPQ0tGSUxFOwogIH0KICBkaWUgIkVSUk9SOiBwb2dvLXdvcmtlciBkaWVkOiAkbXNn\nXG5cbiI7Cn0KCnN1YiBydW5faG9va3MgewogIG15ICRkaXIgPSBzaGlmdDsKICBpZiAoICEtciAk\nZGlyIHx8ICEtZCAkZGlyICkgeyByZXR1cm4gMDsgfQogIG9wZW5kaXIoIG15ICRkaCwgJGRpciAp\nIG9yIGRpZSAiaG9vayBmYWlsZWQsIGNhbid0IG9wZW4gJGRpcjogJCEiOwogIG15IEBmaWxlcyA9\nIG1hcCB7ICRkaXIgLiAkXyB9IHNvcnQgZ3JlcCB7ICEvXlwuLyAmJiAteCAkZGlyIC4gJF8gfSBy\nZWFkZGlyKCRkaCk7CiAgY2xvc2VkaXIoJGRoKTsKICBmb3JlYWNoIG15ICRydW4gKEBmaWxlcykg\newogICAgcHJpbnQgInBvZ28td29ya2VyOiBydW5uaW5nIGhvb2sgJyRydW4nXG4iOwogICAgbXkg\nJHJldCA9IHN5c3RlbSgkcnVuKSA+PiA4OwogICAgaWYgKCAkcmV0ICE9IDAgKSB7IGRpZSAiaG9v\nayAnJHJ1bicgZXhpdGVkICRyZXQsIGJhaWxpbmcgb3V0XG4iOyB9CiAgfQp9CgpzdWIgbWFpbiB7\nCiAgcHJpbnQgIlxuIjsKICBteSAkY29tcGFydG1lbnQgPSBTYWZlLT5uZXcoKTsKICAkb3B0cyA9\nICRjb21wYXJ0bWVudC0+cmV2YWwoPERBVEE+KTsKICBkaWUgInNhZmUgZXZhbCBmYWlsZWQ6ICRA\nIiBpZiAkQDsKICBkaWUgImJhZCBvcHRpb25zXG4iCiAgICB1bmxlc3MgJG9wdHMtPntqb2J9CiAg\nICAgICYmICRvcHRzLT57Y29tbWFuZH0KICAgICAgJiYgZXhpc3RzICRvcHRzLT57cmV0cnl9CiAg\nICAgICYmIGV4aXN0cyAkb3B0cy0+e3RpbWVvdXR9OwogIHByaW50ICJwb2dvLXdvcmtlcjogbG9h\nZGVkOyByZXRyeT0kb3B0cy0+e3JldHJ5fSwgdGltZW91dD0kb3B0cy0+e3RpbWVvdXR9XG4iOwog\nIHByaW50ICJwb2dvLXdvcmtlcjogY29tbWFuZD0nJG9wdHMtPntjb21tYW5kfSdcbiI7CiAgaWYg\nKCAhc3lzb3BlbiggJGxvY2tmaCwgTE9DS0ZJTEUsIE9fQ1JFQVQgfCBPX0VYQ0wgfCBPX1dST05M\nWSApICkgewogICAgbXkgJGNtZCA9ICdjYXQgJyAuIExPQ0tGSUxFOwogICAgY2hvbXAoIG15ICRv\ndGhlcnBpZCA9IHF4KCRjbWQpICk7CiAgICBpZiAoICRvdGhlcnBpZCAmJiAtZCAiL3Byb2MvJG90\naGVycGlkIiApIHsKICAgICAgJmNsZWFudXAoImFub3RoZXIgcG9nby13b3JrZXIgaXMgcnVubmlu\nZyAocGlkICRvdGhlcnBpZCksIGJhaWxpbmcgb3V0Iik7CiAgICB9CiAgICBwcmludCAicG9nby13\nb3JrZXI6IGNsZWFuaW5nIHVwIHN0YWxlIGxvY2tmaWxlXG4iOwogICAgdW5saW5rIExPQ0tGSUxF\nOwogICAgaWYgKCAhc3lzb3BlbiggJGxvY2tmaCwgTE9DS0ZJTEUsIE9fQ1JFQVQgfCBPX0VYQ0wg\nfCBPX1dST05MWSApICkgewogICAgICAmY2xlYW51cCgiY2FuJ3Qgb2J0YWluIGxvY2tmaWxlLCBi\nYWlsaW5nIG91dCIpOwogICAgfQogIH0KICAkbG9ja2VkID0gMTsKICBzZWxlY3QgJGxvY2tmaDsK\nICAkfCA9IDE7CiAgcHJpbnQgIiQkXG4iOwogIHNlbGVjdCBTVERPVVQ7CiAgaWYgKCBleGlzdHMg\nJG9wdHMtPntleGVfbmFtZX0gKSB7CiAgICBteSAoICRoLCAkZiApID0gdGVtcGZpbGUoIHNwcmlu\ndGYoICdwb2dvXyVzX1hYWFgnLCAkb3B0cy0+e2V4ZV9uYW1lfSApLCBESVIgPT4gVEVNUERJUigp\nICk7CiAgICB7CiAgICAgIGxvY2FsICQvOwogICAgICBwcmludCAkaCA8REFUQT47CiAgICB9CiAg\nICBjbG9zZSgkaCk7CiAgICBjaG1vZCAwNzAwLCAkdGVtcGZpbGUgPSAkb3B0cy0+e2NvbW1hbmR9\nID0gJGY7CiAgfQogIHJ1bl9ob29rcyhQUkVfSE9PS0RJUikgaWYgKCAkb3B0cy0+e3ByZWhvb2t9\nICk7CiAgcHJpbnQgInBvZ28td29ya2VyOiBydW5uaW5nIGNvbW1hbmQgJyRvcHRzLT57Y29tbWFu\nZH0nXG4iOwogIG15ICRjb3VudCA9IDA7CiAgbXkgJHJldCAgID0gLTE7CiAgd2hpbGUgKCAkcmV0\nICE9IDAgJiYgJGNvdW50IDw9ICRvcHRzLT57cmV0cnl9ICkgewogICAgZXZhbCB7CiAgICAgICRT\nSUd7QUxSTX0gPSBzdWIgeyBkaWUgImNvbW1hbmQgdGltZWQgb3V0XG4iOyB9OwogICAgICBhbGFy\nbSAkb3B0cy0+e3RpbWVvdXR9OwogICAgICAkcmV0ID0gc3lzdGVtKCAkb3B0cy0+e2NvbW1hbmR9\nICkgPj4gODsKICAgICAgYWxhcm0gMDsKICAgIH07CiAgICBpZiAoJEApIHsgZGllICJjb21tYW5k\nIHRpbWVkIG91dFxuIjsgfQogICAgbGFzdCBpZiAkcmV0ID09IDA7CiAgICBwcmludCAiV0FSTklO\nRzogcG9nby13b3JrZXI6IGNvbW1hbmQgZXhpdGVkICRyZXQiOwogICAgJGNvdW50ID8gcHJpbnQg\nIiwgcmV0cnkgJGNvdW50IG9mICRvcHRzLT57cmV0cnl9XG4iIDogcHJpbnQgIlxuIjsKICAgICRj\nb3VudCsrOwogICAgc2xlZXAgNTsKICB9CiAgaWYgKCAkcmV0ICE9IDAgKSB7IGRpZSAiY29tbWFu\nZCBleGl0ZWQgJHJldFxuIjsgfQogIHByaW50ICJwb2dvLXdvcmtlcjogY29tbWFuZCBleGl0ICRy\nZXRcbiI7CiAgcnVuX2hvb2tzKFBPU1RfSE9PS0RJUikgaWYgJG9wdHMtPntwb3N0aG9va307CiAg\naWYgKCAkdGVtcGZpbGUgJiYgLWUgJHRlbXBmaWxlICkgewogICAgdW5saW5rICR0ZW1wZmlsZTsK\nICB9CiAgdW5saW5rIExPQ0tGSUxFOwogIHByaW50ICJcbiI7CiAgcmV0dXJuICRyZXQ7Cn0KZXhp\ndCAmbWFpbjsKX19EQVRBX18KeyJjb25jdXJyZW50IiA9PiAxLCJpbnZva2VkX2FzIiA9PiAiYmlu\nL3BvZ28tY2xpZW50IC0tY29uZmlnZmlsZSAvaG9tZS9zc2luZ2FuL2NsaWVudC5jb25mIHJ1biAt\naCBsb2NhbGhvc3QgJ3RvdWNoIC90bXAvcG9nb19jbWRsaW5lJyAtLXVzZS1wYXNzd29yZCAiLCJu\nYW1lc3BhY2UiID0+ICJleGFtcGxlIiwicnVuX2FzIiA9PiAic3NpbmdhbiIsImFwaSIgPT4gdW5k\nZWYsImpvYiIgPT4gInAwMDAwMDAwMDEzIiwicmV0cnkiID0+IDAsImNsaWVudCIgPT4gIiIsInRh\ncmdldCIgPT4gIltcImxvY2FsaG9zdFwiXSIsInRpbWVvdXQiID0+IDUsInVzZXIiID0+ICJzc2lu\nZ2FuIiwiam9iX3RpbWVvdXQiID0+IDEwLCJyZXF1ZXN0aG9zdCIgPT4gImJvYXJkcHJlcGFyZS5j\nb3JwLnlhaG9vLmNvbSIsImNvbW1hbmQiID0+ICJ0b3VjaCAvdG1wL3BvZ29fY21kbGluZSJ9\n"]}';

  $writer->print($task);
  $writer->close;

  $output .= $_ while (<$reader>);

}
"pogo test" or diag explain $@;

ok( $output =~ m/ERROR/, "grep for error" );

$output = "";
#incorrect pvt key and passphhrase
lives_ok
{
  my ( $writer, $reader ) = ( IO::Handle->new, IO::Handle->new );
  my $pid =
    open3( $writer, $reader, undef, $exec_helper, '-e', $expect_wrapper, '-k', $worker_key );

  my $task =
    '{"client_private_key":["TNIonr3yB0MyAZdlvrsnvw3WNxxzh/2tgPLGPV36gtOZIOHdUjO0a+fKk+02Ym3JLT82caS1GMIq\nsE2jlcSaUM3ZVn/0V1ZzwD7f5ivbVFKSb7VCd7EY6XFhwqVWb9b3dHpIrj7SJDU0M6fhgKguWe4S\nomidIysvsZPJZdP/WqFUPpQsGwJdTjuFGFTrMIj7oNnex4NofDxg6n+IWrdRmPVFgEEr5UGRJQNE\nKhpz4K15hPWq17PbIVW1qTJ2PESJ9M+HU+/Ep+3Tm2HOCLbOvQV6WEnyDgWiekEUUQVGJehEQ6R/\nDbL1S/ZXizFfg3Tt7amEOme8Af8Xg9gonHq+zO/73DZHPZf5wWoH7wxdJpR0V6cJLIMrXoZxB0bz\nGVArb+lwP22GIodc63gFF22r9NNSyDrpEyxDWvgjZeYwFjHBE2vc+Dth/IiAp6D2ciwjCoAo6XVr\nWwEzDkltF3U8w8GytVb27egnKp4xXAIz8JLFd/COZCytc7f8wTc4KTjy4sDLYVO4M4cMx/nmV2Ck\n4rwZ+zac2rpfyChaCXLsGy1CYgOFmTZH3yECP/NW+dHFB8AZlCTDaYwEnG0KewTINuJnRCWrWrRq\noaxOn4H0TbdJKc/g16LW7uL7vesRbeSU+bPi2H6GzmsL7UiCas8fwPwsCtstNOdm8rNp9/rIjHI=\n"],"job_id":"p0000000014","secrets":"DK92A4OgqQDjfJLvkoqVEI6Xpjqvs9jgkDxL0Pxr/ZkmiznPtc/IW6xKrNMThYKH18Z7uUO9PZ8E\n2nrovCnOBnXZnbz3U3KNYBHgJkydzKEmFyEKBNB0Wuf4WP4GzBXp1qE0pQZPsQw7CFcIiTRQBJDc\nbrmWZ2roUdeqPoWfzyTS8s6KOJOboYNSv+vt0dp15k+miMOwIFBG0fSceulLKcTYpJCP4M/Z6XzX\nCcDRSJCGrrp/65aOR1uyk72fvx15RSNBhroJioVZZn/KuGnoa6pZWo7l6qjhUwA2KMvJggI0TlAC\nrmIOJlq4/h42onRLSpe8KqN20OpbtCqx4F+8vmFVfUMwv7LJMwA4PQ3YoAyHRfOvsQ8O/Vz6iqWy\noPHfolsqtbN3CF/71dBam2Fx8Ku9f6zmb9MvthwEqR4yUh2ZHGjML6T2VmRaSjatkOmi8Xda7KTx\n4BVecaoShSbu05WzKziF1k3ZIqGfdYMyvq06smnCAxrLRUqzOLG5/OEp5VliZ1ZEhECl889JAxQM\nfnYw7Yhk0iZM+p42HYoSN4XbxMD/BHTbbbCkaqFIAHv9eNuGrl7ZG9UY2hlp62Ni9lisZ8WyBIqz\nAhE+rbfu2JI6CDNbkOPbPCatYpk9gtxlZ1iLHQ5Iw612DE6QB/ypySp8C9GOhgWh89BGq0hep5k=\n","run_as":"ssingan","host":"localhost","password":null,"timeout":"5","pvt_key_passphrase":"Qf7avLLXOULI+iPaWrLpInOCyoYKTAgggLgW8ItnwHFENm57eXMCBBhr1eeEv0uKRzOTPv2QHao/\nLkpQtKEG2IFeNjLsmeu9zsxL0nW8St40Q36+/8iRsnboraAR4OtNEcSt3CsTDBIL7L3O3Ul6W301\nhM/MORmIOd3CUQahknzncli1PJBqsGG++tOxzQE9q227oYi0rVCJm3rrkB4EtB/nR/kZCl9sy0I2\nx0AEk8koZU1ytGkrSyAm1FWBglhQI25zAHcnxHv6U3KMcDNDhsIvbbi+WcwD5QA1vefnRH6nwjyL\nLsL8PDQ8VewzdXp0LvZmK2Uzv2sYwgYaloi2ou5FOjolkl14V1Ka7dBIR0IxszzqprL7C0vc4ges\nTymT01c2qFl0x3PYd0/S08F6ByVStQIzDwsQ8CcD9MyFVMLob2rI30BrEpQ8y8JZzwhRDwlup9hL\nFT8iCtI91nM5vetgbVByLYHOfTPt5nxpA4zO99/TNh+CZZ0/RKgX8WszNj1nIL3GvGyATLm2/y59\nhIk//0GGJidVvxyHi9CcNcsgGBPkWKAaHtattVprqcjB9GFCJyp4Yaom+5aNV+rutlvxheMwydOR\n0C8MG95PXLJHvdtvgCxVQk05PzoqaHpQqf2XVtgqD5Cs3aariy0U2q2YwnRYEOQjbrNlCXeRPbc=\n","user":"ssingan","command":["POGOATTACHMENT!IyEvdXNyL2Jpbi9lbnYgcGVybAoKdXNlIDUuMDA4Owp1c2Ugd2FybmluZ3M7CnVzZSBzdHJpY3Q7\nCgp1c2UgRmNudGw7CnVzZSBGaWxlOjpUZW1wIHF3KHRlbXBmaWxlKTsKdXNlIFN5czo6SG9zdG5h\nbWUgcXcoaG9zdG5hbWUpOwp1c2UgY29uc3RhbnQgTE9DS0ZJTEUgICAgID0+ICcvdG1wL3BvZ29f\nd29ya2VyLmxvY2snOwp1c2UgY29uc3RhbnQgUE9TVF9IT09LRElSID0+ICcvZXRjL3BvZ28vcG9z\ndC5kLyc7CnVzZSBjb25zdGFudCBQUkVfSE9PS0RJUiAgPT4gJy9ldGMvcG9nby9wcmUuZC8nOwp1\nc2UgY29uc3RhbnQgVEVNUERJUiAgICAgID0+ICcvdG1wJzsKdXNlIFNhZmU7CgokU0lHe0hVUH0g\nPSAkU0lHe0lOVH0gPSAkU0lHe1RFUk19ID0gJFNJR3tfX0RJRV9ffSA9IFwmY2xlYW51cDsKCm15\nICRob3N0bmFtZSA9IGhvc3RuYW1lKCk7Cm15ICRsb2NrZWQgICA9IDA7Cm15ICRsb2NrZmggICA9\nIHVuZGVmOwpteSAkb3B0cyAgICAgPSB1bmRlZjsKbXkgJHRlbXBmaWxlID0gdW5kZWY7CgpzdWIg\nY2xlYW51cCB7CiAgbXkgJG1zZyA9IHNoaWZ0OwogIGlmICggJG1zZyA9fiBtL15bQS1aXSskLyAp\nIHsgJG1zZyA9ICdnb3QgU0lHJyAuICRtc2c7IH0KICBpZiAoICR0ZW1wZmlsZSAmJiAtZSAkdGVt\ncGZpbGUgKSB7CiAgICB1bmxpbmsgJHRlbXBmaWxlOwogIH0KICBpZiAoJGxvY2tlZCkgewogICAg\ncHJpbnQgInBvZ28td29ya2VyOiB1bmxvY2tpbmdcbiI7CiAgICBjbG9zZSAkbG9ja2ZoOwogICAg\ndW5saW5rIExPQ0tGSUxFOwogIH0KICBkaWUgIkVSUk9SOiBwb2dvLXdvcmtlciBkaWVkOiAkbXNn\nXG5cbiI7Cn0KCnN1YiBydW5faG9va3MgewogIG15ICRkaXIgPSBzaGlmdDsKICBpZiAoICEtciAk\nZGlyIHx8ICEtZCAkZGlyICkgeyByZXR1cm4gMDsgfQogIG9wZW5kaXIoIG15ICRkaCwgJGRpciAp\nIG9yIGRpZSAiaG9vayBmYWlsZWQsIGNhbid0IG9wZW4gJGRpcjogJCEiOwogIG15IEBmaWxlcyA9\nIG1hcCB7ICRkaXIgLiAkXyB9IHNvcnQgZ3JlcCB7ICEvXlwuLyAmJiAteCAkZGlyIC4gJF8gfSBy\nZWFkZGlyKCRkaCk7CiAgY2xvc2VkaXIoJGRoKTsKICBmb3JlYWNoIG15ICRydW4gKEBmaWxlcykg\newogICAgcHJpbnQgInBvZ28td29ya2VyOiBydW5uaW5nIGhvb2sgJyRydW4nXG4iOwogICAgbXkg\nJHJldCA9IHN5c3RlbSgkcnVuKSA+PiA4OwogICAgaWYgKCAkcmV0ICE9IDAgKSB7IGRpZSAiaG9v\nayAnJHJ1bicgZXhpdGVkICRyZXQsIGJhaWxpbmcgb3V0XG4iOyB9CiAgfQp9CgpzdWIgbWFpbiB7\nCiAgcHJpbnQgIlxuIjsKICBteSAkY29tcGFydG1lbnQgPSBTYWZlLT5uZXcoKTsKICAkb3B0cyA9\nICRjb21wYXJ0bWVudC0+cmV2YWwoPERBVEE+KTsKICBkaWUgInNhZmUgZXZhbCBmYWlsZWQ6ICRA\nIiBpZiAkQDsKICBkaWUgImJhZCBvcHRpb25zXG4iCiAgICB1bmxlc3MgJG9wdHMtPntqb2J9CiAg\nICAgICYmICRvcHRzLT57Y29tbWFuZH0KICAgICAgJiYgZXhpc3RzICRvcHRzLT57cmV0cnl9CiAg\nICAgICYmIGV4aXN0cyAkb3B0cy0+e3RpbWVvdXR9OwogIHByaW50ICJwb2dvLXdvcmtlcjogbG9h\nZGVkOyByZXRyeT0kb3B0cy0+e3JldHJ5fSwgdGltZW91dD0kb3B0cy0+e3RpbWVvdXR9XG4iOwog\nIHByaW50ICJwb2dvLXdvcmtlcjogY29tbWFuZD0nJG9wdHMtPntjb21tYW5kfSdcbiI7CiAgaWYg\nKCAhc3lzb3BlbiggJGxvY2tmaCwgTE9DS0ZJTEUsIE9fQ1JFQVQgfCBPX0VYQ0wgfCBPX1dST05M\nWSApICkgewogICAgbXkgJGNtZCA9ICdjYXQgJyAuIExPQ0tGSUxFOwogICAgY2hvbXAoIG15ICRv\ndGhlcnBpZCA9IHF4KCRjbWQpICk7CiAgICBpZiAoICRvdGhlcnBpZCAmJiAtZCAiL3Byb2MvJG90\naGVycGlkIiApIHsKICAgICAgJmNsZWFudXAoImFub3RoZXIgcG9nby13b3JrZXIgaXMgcnVubmlu\nZyAocGlkICRvdGhlcnBpZCksIGJhaWxpbmcgb3V0Iik7CiAgICB9CiAgICBwcmludCAicG9nby13\nb3JrZXI6IGNsZWFuaW5nIHVwIHN0YWxlIGxvY2tmaWxlXG4iOwogICAgdW5saW5rIExPQ0tGSUxF\nOwogICAgaWYgKCAhc3lzb3BlbiggJGxvY2tmaCwgTE9DS0ZJTEUsIE9fQ1JFQVQgfCBPX0VYQ0wg\nfCBPX1dST05MWSApICkgewogICAgICAmY2xlYW51cCgiY2FuJ3Qgb2J0YWluIGxvY2tmaWxlLCBi\nYWlsaW5nIG91dCIpOwogICAgfQogIH0KICAkbG9ja2VkID0gMTsKICBzZWxlY3QgJGxvY2tmaDsK\nICAkfCA9IDE7CiAgcHJpbnQgIiQkXG4iOwogIHNlbGVjdCBTVERPVVQ7CiAgaWYgKCBleGlzdHMg\nJG9wdHMtPntleGVfbmFtZX0gKSB7CiAgICBteSAoICRoLCAkZiApID0gdGVtcGZpbGUoIHNwcmlu\ndGYoICdwb2dvXyVzX1hYWFgnLCAkb3B0cy0+e2V4ZV9uYW1lfSApLCBESVIgPT4gVEVNUERJUigp\nICk7CiAgICB7CiAgICAgIGxvY2FsICQvOwogICAgICBwcmludCAkaCA8REFUQT47CiAgICB9CiAg\nICBjbG9zZSgkaCk7CiAgICBjaG1vZCAwNzAwLCAkdGVtcGZpbGUgPSAkb3B0cy0+e2NvbW1hbmR9\nID0gJGY7CiAgfQogIHJ1bl9ob29rcyhQUkVfSE9PS0RJUikgaWYgKCAkb3B0cy0+e3ByZWhvb2t9\nICk7CiAgcHJpbnQgInBvZ28td29ya2VyOiBydW5uaW5nIGNvbW1hbmQgJyRvcHRzLT57Y29tbWFu\nZH0nXG4iOwogIG15ICRjb3VudCA9IDA7CiAgbXkgJHJldCAgID0gLTE7CiAgd2hpbGUgKCAkcmV0\nICE9IDAgJiYgJGNvdW50IDw9ICRvcHRzLT57cmV0cnl9ICkgewogICAgZXZhbCB7CiAgICAgICRT\nSUd7QUxSTX0gPSBzdWIgeyBkaWUgImNvbW1hbmQgdGltZWQgb3V0XG4iOyB9OwogICAgICBhbGFy\nbSAkb3B0cy0+e3RpbWVvdXR9OwogICAgICAkcmV0ID0gc3lzdGVtKCAkb3B0cy0+e2NvbW1hbmR9\nICkgPj4gODsKICAgICAgYWxhcm0gMDsKICAgIH07CiAgICBpZiAoJEApIHsgZGllICJjb21tYW5k\nIHRpbWVkIG91dFxuIjsgfQogICAgbGFzdCBpZiAkcmV0ID09IDA7CiAgICBwcmludCAiV0FSTklO\nRzogcG9nby13b3JrZXI6IGNvbW1hbmQgZXhpdGVkICRyZXQiOwogICAgJGNvdW50ID8gcHJpbnQg\nIiwgcmV0cnkgJGNvdW50IG9mICRvcHRzLT57cmV0cnl9XG4iIDogcHJpbnQgIlxuIjsKICAgICRj\nb3VudCsrOwogICAgc2xlZXAgNTsKICB9CiAgaWYgKCAkcmV0ICE9IDAgKSB7IGRpZSAiY29tbWFu\nZCBleGl0ZWQgJHJldFxuIjsgfQogIHByaW50ICJwb2dvLXdvcmtlcjogY29tbWFuZCBleGl0ICRy\nZXRcbiI7CiAgcnVuX2hvb2tzKFBPU1RfSE9PS0RJUikgaWYgJG9wdHMtPntwb3N0aG9va307CiAg\naWYgKCAkdGVtcGZpbGUgJiYgLWUgJHRlbXBmaWxlICkgewogICAgdW5saW5rICR0ZW1wZmlsZTsK\nICB9CiAgdW5saW5rIExPQ0tGSUxFOwogIHByaW50ICJcbiI7CiAgcmV0dXJuICRyZXQ7Cn0KZXhp\ndCAmbWFpbjsKX19EQVRBX18KeyJjb25jdXJyZW50IiA9PiAxLCJpbnZva2VkX2FzIiA9PiAiYmlu\nL3BvZ28tY2xpZW50IC0tY29uZmlnZmlsZSAvaG9tZS9zc2luZ2FuL2NsaWVudC5jb25mIHJ1biAt\naCBsb2NhbGhvc3QgJ3RvdWNoIC90bXAvcG9nb19jbWRsaW5lJyAtLXNzaGFnZW50IC0tcGstZmls\nZSBwa2ZpbGUgIiwibmFtZXNwYWNlIiA9PiAiZXhhbXBsZSIsInJ1bl9hcyIgPT4gInNzaW5nYW4i\nLCJhcGkiID0+IHVuZGVmLCJqb2IiID0+ICJwMDAwMDAwMDAxNCIsInJldHJ5IiA9PiAwLCJjbGll\nbnQiID0+ICIiLCJ0YXJnZXQiID0+ICJbXCJsb2NhbGhvc3RcIl0iLCJ0aW1lb3V0IiA9PiA1LCJ1\nc2VyIiA9PiAic3NpbmdhbiIsImpvYl90aW1lb3V0IiA9PiAxMCwicmVxdWVzdGhvc3QiID0+ICJi\nb2FyZHByZXBhcmUuY29ycC55YWhvby5jb20iLCJjb21tYW5kIiA9PiAidG91Y2ggL3RtcC9wb2dv\nX2NtZGxpbmUifQ==\n"]}';

  $writer->print($task);
  $writer->close;

  $output .= $_ while (<$reader>);

}
"pogo test with incorrect passphrase" or diag explain $@;

ok( $output =~ m/ERROR/, "grep for error" );

$output = "";
#no password or passphrase
lives_ok
{
  my ( $writer, $reader ) = ( IO::Handle->new, IO::Handle->new );
  my $pid =
    open3( $writer, $reader, undef, $exec_helper, '-e', $expect_wrapper, '-k', $worker_key );

  my $task =
    '{"client_private_key":null,"job_id":"p0000000013","secrets":"CqQbV/yhFMAFoFd+E3nrAgYPVOB3OY+YzZkSKxlS/07gbH0zkbC2+hWHn6+G8zsIz86Tldvl+Wqt\nYLvAL5nlGfY4ydn0MmQGma7ScC2bAKpIoYr40M36uGV78cW+cAFb/Bz60Jxu1yufNaCOvdMR1aCz\n6JdWqwVm2/GQcbV5AC2YVrZAiw8kjPJW9guPCB9INSF8fTFHZYPl70gEE1uZ2M26gRu5+PJVnp5H\nVnMWgWHbydqoNs9dLDPwF93HekmewDJJ6FxMSJeMTrDEmyG1H+vUVd6//YR4QSN9OeXxFUzm4kDH\nZM+mj2CgJkAtaAte2t0BDrDG7+mqCIHOoZpOhl7VNeJES2sM4oFv6pjJbXTo3ICeZn3WY4V+gtOW\nPwvksjK4PcHCz14e/IR2yDh9cBpt2DWfwVXes5MJQfx1Jz6GJm5pBdi5zxy8mVmrolcPWC+ZCrSf\nGV6r+x89wKWL4HreMb/BUw1lGEk9J74a9fiyAaaj1b/+C1Yc4DoQL377koRBTlon7SeLjMw5l9vU\nl4iOs2QdmQosgLqHmcpdZPekraGmifYQusDQ+mPxfku/ZZasyJFoKX13/iRRW3DVrk3L6UFx+dGC\n6CFmyQefjsuDp2R0bAiF8ogXm/qwP+V11J3Yeaar6jHqJpA7OKJsL9jQrRf7jStMs4ucXI6eseI=\n","run_as":"ssingan","host":"localhost","password":null,"timeout":"5","pvt_key_passphrase":null,"user":"ssingan","command":["POGOATTACHMENT!IyEvdXNyL2Jpbi9lbnYgcGVybAoKdXNlIDUuMDA4Owp1c2Ugd2FybmluZ3M7CnVzZSBzdHJpY3Q7\nCgp1c2UgRmNudGw7CnVzZSBGaWxlOjpUZW1wIHF3KHRlbXBmaWxlKTsKdXNlIFN5czo6SG9zdG5h\nbWUgcXcoaG9zdG5hbWUpOwp1c2UgY29uc3RhbnQgTE9DS0ZJTEUgICAgID0+ICcvdG1wL3BvZ29f\nd29ya2VyLmxvY2snOwp1c2UgY29uc3RhbnQgUE9TVF9IT09LRElSID0+ICcvZXRjL3BvZ28vcG9z\ndC5kLyc7CnVzZSBjb25zdGFudCBQUkVfSE9PS0RJUiAgPT4gJy9ldGMvcG9nby9wcmUuZC8nOwp1\nc2UgY29uc3RhbnQgVEVNUERJUiAgICAgID0+ICcvdG1wJzsKdXNlIFNhZmU7CgokU0lHe0hVUH0g\nPSAkU0lHe0lOVH0gPSAkU0lHe1RFUk19ID0gJFNJR3tfX0RJRV9ffSA9IFwmY2xlYW51cDsKCm15\nICRob3N0bmFtZSA9IGhvc3RuYW1lKCk7Cm15ICRsb2NrZWQgICA9IDA7Cm15ICRsb2NrZmggICA9\nIHVuZGVmOwpteSAkb3B0cyAgICAgPSB1bmRlZjsKbXkgJHRlbXBmaWxlID0gdW5kZWY7CgpzdWIg\nY2xlYW51cCB7CiAgbXkgJG1zZyA9IHNoaWZ0OwogIGlmICggJG1zZyA9fiBtL15bQS1aXSskLyAp\nIHsgJG1zZyA9ICdnb3QgU0lHJyAuICRtc2c7IH0KICBpZiAoICR0ZW1wZmlsZSAmJiAtZSAkdGVt\ncGZpbGUgKSB7CiAgICB1bmxpbmsgJHRlbXBmaWxlOwogIH0KICBpZiAoJGxvY2tlZCkgewogICAg\ncHJpbnQgInBvZ28td29ya2VyOiB1bmxvY2tpbmdcbiI7CiAgICBjbG9zZSAkbG9ja2ZoOwogICAg\ndW5saW5rIExPQ0tGSUxFOwogIH0KICBkaWUgIkVSUk9SOiBwb2dvLXdvcmtlciBkaWVkOiAkbXNn\nXG5cbiI7Cn0KCnN1YiBydW5faG9va3MgewogIG15ICRkaXIgPSBzaGlmdDsKICBpZiAoICEtciAk\nZGlyIHx8ICEtZCAkZGlyICkgeyByZXR1cm4gMDsgfQogIG9wZW5kaXIoIG15ICRkaCwgJGRpciAp\nIG9yIGRpZSAiaG9vayBmYWlsZWQsIGNhbid0IG9wZW4gJGRpcjogJCEiOwogIG15IEBmaWxlcyA9\nIG1hcCB7ICRkaXIgLiAkXyB9IHNvcnQgZ3JlcCB7ICEvXlwuLyAmJiAteCAkZGlyIC4gJF8gfSBy\nZWFkZGlyKCRkaCk7CiAgY2xvc2VkaXIoJGRoKTsKICBmb3JlYWNoIG15ICRydW4gKEBmaWxlcykg\newogICAgcHJpbnQgInBvZ28td29ya2VyOiBydW5uaW5nIGhvb2sgJyRydW4nXG4iOwogICAgbXkg\nJHJldCA9IHN5c3RlbSgkcnVuKSA+PiA4OwogICAgaWYgKCAkcmV0ICE9IDAgKSB7IGRpZSAiaG9v\nayAnJHJ1bicgZXhpdGVkICRyZXQsIGJhaWxpbmcgb3V0XG4iOyB9CiAgfQp9CgpzdWIgbWFpbiB7\nCiAgcHJpbnQgIlxuIjsKICBteSAkY29tcGFydG1lbnQgPSBTYWZlLT5uZXcoKTsKICAkb3B0cyA9\nICRjb21wYXJ0bWVudC0+cmV2YWwoPERBVEE+KTsKICBkaWUgInNhZmUgZXZhbCBmYWlsZWQ6ICRA\nIiBpZiAkQDsKICBkaWUgImJhZCBvcHRpb25zXG4iCiAgICB1bmxlc3MgJG9wdHMtPntqb2J9CiAg\nICAgICYmICRvcHRzLT57Y29tbWFuZH0KICAgICAgJiYgZXhpc3RzICRvcHRzLT57cmV0cnl9CiAg\nICAgICYmIGV4aXN0cyAkb3B0cy0+e3RpbWVvdXR9OwogIHByaW50ICJwb2dvLXdvcmtlcjogbG9h\nZGVkOyByZXRyeT0kb3B0cy0+e3JldHJ5fSwgdGltZW91dD0kb3B0cy0+e3RpbWVvdXR9XG4iOwog\nIHByaW50ICJwb2dvLXdvcmtlcjogY29tbWFuZD0nJG9wdHMtPntjb21tYW5kfSdcbiI7CiAgaWYg\nKCAhc3lzb3BlbiggJGxvY2tmaCwgTE9DS0ZJTEUsIE9fQ1JFQVQgfCBPX0VYQ0wgfCBPX1dST05M\nWSApICkgewogICAgbXkgJGNtZCA9ICdjYXQgJyAuIExPQ0tGSUxFOwogICAgY2hvbXAoIG15ICRv\ndGhlcnBpZCA9IHF4KCRjbWQpICk7CiAgICBpZiAoICRvdGhlcnBpZCAmJiAtZCAiL3Byb2MvJG90\naGVycGlkIiApIHsKICAgICAgJmNsZWFudXAoImFub3RoZXIgcG9nby13b3JrZXIgaXMgcnVubmlu\nZyAocGlkICRvdGhlcnBpZCksIGJhaWxpbmcgb3V0Iik7CiAgICB9CiAgICBwcmludCAicG9nby13\nb3JrZXI6IGNsZWFuaW5nIHVwIHN0YWxlIGxvY2tmaWxlXG4iOwogICAgdW5saW5rIExPQ0tGSUxF\nOwogICAgaWYgKCAhc3lzb3BlbiggJGxvY2tmaCwgTE9DS0ZJTEUsIE9fQ1JFQVQgfCBPX0VYQ0wg\nfCBPX1dST05MWSApICkgewogICAgICAmY2xlYW51cCgiY2FuJ3Qgb2J0YWluIGxvY2tmaWxlLCBi\nYWlsaW5nIG91dCIpOwogICAgfQogIH0KICAkbG9ja2VkID0gMTsKICBzZWxlY3QgJGxvY2tmaDsK\nICAkfCA9IDE7CiAgcHJpbnQgIiQkXG4iOwogIHNlbGVjdCBTVERPVVQ7CiAgaWYgKCBleGlzdHMg\nJG9wdHMtPntleGVfbmFtZX0gKSB7CiAgICBteSAoICRoLCAkZiApID0gdGVtcGZpbGUoIHNwcmlu\ndGYoICdwb2dvXyVzX1hYWFgnLCAkb3B0cy0+e2V4ZV9uYW1lfSApLCBESVIgPT4gVEVNUERJUigp\nICk7CiAgICB7CiAgICAgIGxvY2FsICQvOwogICAgICBwcmludCAkaCA8REFUQT47CiAgICB9CiAg\nICBjbG9zZSgkaCk7CiAgICBjaG1vZCAwNzAwLCAkdGVtcGZpbGUgPSAkb3B0cy0+e2NvbW1hbmR9\nID0gJGY7CiAgfQogIHJ1bl9ob29rcyhQUkVfSE9PS0RJUikgaWYgKCAkb3B0cy0+e3ByZWhvb2t9\nICk7CiAgcHJpbnQgInBvZ28td29ya2VyOiBydW5uaW5nIGNvbW1hbmQgJyRvcHRzLT57Y29tbWFu\nZH0nXG4iOwogIG15ICRjb3VudCA9IDA7CiAgbXkgJHJldCAgID0gLTE7CiAgd2hpbGUgKCAkcmV0\nICE9IDAgJiYgJGNvdW50IDw9ICRvcHRzLT57cmV0cnl9ICkgewogICAgZXZhbCB7CiAgICAgICRT\nSUd7QUxSTX0gPSBzdWIgeyBkaWUgImNvbW1hbmQgdGltZWQgb3V0XG4iOyB9OwogICAgICBhbGFy\nbSAkb3B0cy0+e3RpbWVvdXR9OwogICAgICAkcmV0ID0gc3lzdGVtKCAkb3B0cy0+e2NvbW1hbmR9\nICkgPj4gODsKICAgICAgYWxhcm0gMDsKICAgIH07CiAgICBpZiAoJEApIHsgZGllICJjb21tYW5k\nIHRpbWVkIG91dFxuIjsgfQogICAgbGFzdCBpZiAkcmV0ID09IDA7CiAgICBwcmludCAiV0FSTklO\nRzogcG9nby13b3JrZXI6IGNvbW1hbmQgZXhpdGVkICRyZXQiOwogICAgJGNvdW50ID8gcHJpbnQg\nIiwgcmV0cnkgJGNvdW50IG9mICRvcHRzLT57cmV0cnl9XG4iIDogcHJpbnQgIlxuIjsKICAgICRj\nb3VudCsrOwogICAgc2xlZXAgNTsKICB9CiAgaWYgKCAkcmV0ICE9IDAgKSB7IGRpZSAiY29tbWFu\nZCBleGl0ZWQgJHJldFxuIjsgfQogIHByaW50ICJwb2dvLXdvcmtlcjogY29tbWFuZCBleGl0ICRy\nZXRcbiI7CiAgcnVuX2hvb2tzKFBPU1RfSE9PS0RJUikgaWYgJG9wdHMtPntwb3N0aG9va307CiAg\naWYgKCAkdGVtcGZpbGUgJiYgLWUgJHRlbXBmaWxlICkgewogICAgdW5saW5rICR0ZW1wZmlsZTsK\nICB9CiAgdW5saW5rIExPQ0tGSUxFOwogIHByaW50ICJcbiI7CiAgcmV0dXJuICRyZXQ7Cn0KZXhp\ndCAmbWFpbjsKX19EQVRBX18KeyJjb25jdXJyZW50IiA9PiAxLCJpbnZva2VkX2FzIiA9PiAiYmlu\nL3BvZ28tY2xpZW50IC0tY29uZmlnZmlsZSAvaG9tZS9zc2luZ2FuL2NsaWVudC5jb25mIHJ1biAt\naCBsb2NhbGhvc3QgJ3RvdWNoIC90bXAvcG9nb19jbWRsaW5lJyAtLXVzZS1wYXNzd29yZCAiLCJu\nYW1lc3BhY2UiID0+ICJleGFtcGxlIiwicnVuX2FzIiA9PiAic3NpbmdhbiIsImFwaSIgPT4gdW5k\nZWYsImpvYiIgPT4gInAwMDAwMDAwMDEzIiwicmV0cnkiID0+IDAsImNsaWVudCIgPT4gIiIsInRh\ncmdldCIgPT4gIltcImxvY2FsaG9zdFwiXSIsInRpbWVvdXQiID0+IDUsInVzZXIiID0+ICJzc2lu\nZ2FuIiwiam9iX3RpbWVvdXQiID0+IDEwLCJyZXF1ZXN0aG9zdCIgPT4gImJvYXJkcHJlcGFyZS5j\nb3JwLnlhaG9vLmNvbSIsImNvbW1hbmQiID0+ICJ0b3VjaCAvdG1wL3BvZ29fY21kbGluZSJ9\n"]}';

  $writer->print($task);
  $writer->close;

  $output .= $_ while (<$reader>);

}
"pogo with no password or passphrase" or diag explain $@;

ok( $output =~ m/ERROR/, "grep for error" );

ok( 1, "at the end" );

1;

